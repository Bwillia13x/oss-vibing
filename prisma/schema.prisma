// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================================================
// User Management
// ============================================================================

model User {
  id          String   @id @default(cuid())
  email       String   @unique
  name        String?
  role        Role     @default(USER)
  status      UserStatus @default(ACTIVE)
  lastLoginAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  documents      Document[]
  references     Reference[]
  citations      Citation[]
  auditLogs      AuditLog[]
  roomACLs       RoomACL[]
  
  @@index([email])
  @@index([role])
  @@index([createdAt])
  @@index([lastLoginAt])
}

enum Role {
  USER
  ADMIN
  INSTRUCTOR
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  DELETED
}

// ============================================================================
// Content Management
// ============================================================================

model Document {
  id          String       @id @default(cuid())
  userId      String
  title       String
  content     String       // MDX content
  type        DocumentType @default(NOTE)
  status      DocumentStatus @default(DRAFT)
  folder      String?      // Path like "docs/research"
  tags        String?      // JSON array
  metadata    String?      // JSON object
  yjsState    Bytes?       // Stores Yjs CRDT state for real-time collaboration
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  // Relations
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  citations   Citation[]
  roomACLs    RoomACL[]
  
  @@index([userId])
  @@index([type])
  @@index([status])
  @@index([folder])
  @@index([createdAt])
}

enum DocumentType {
  NOTE
  ESSAY
  THESIS
  LAB_REPORT
  PRESENTATION
  SPREADSHEET
  OTHER
}

enum DocumentStatus {
  DRAFT
  IN_PROGRESS
  COMPLETED
  ARCHIVED
}

// ============================================================================
// Collaboration & Access Control
// ============================================================================

model RoomACL {
  id          String   @id @default(cuid())
  documentId  String
  userId      String
  permission  String   // 'viewer' | 'editor' | 'owner'
  invitedById String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  document Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([documentId, userId])
  @@index([documentId])
  @@index([userId])
  @@index([permission])
}

// ============================================================================
// Citation & Reference Management
// ============================================================================

model Reference {
  id          String   @id @default(cuid())
  userId      String
  doi         String?
  url         String?
  title       String
  authors     String   // JSON array
  year        Int?
  journal     String?
  volume      String?
  pages       String?
  publisher   String?
  type        String   @default("article-journal")
  metadata    String?  // Full CSL JSON
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  citations   Citation[]
  
  @@index([userId])
  @@index([doi])
  @@index([createdAt])
}

model Citation {
  id          String   @id @default(cuid())
  documentId  String
  referenceId String
  userId      String
  location    String?  // Page number or section
  context     String?  // Surrounding text
  type        CitationType @default(IN_TEXT)
  createdAt   DateTime @default(now())
  
  // Relations
  document    Document  @relation(fields: [documentId], references: [id], onDelete: Cascade)
  reference   Reference @relation(fields: [referenceId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([documentId])
  @@index([referenceId])
  @@index([userId])
}

enum CitationType {
  IN_TEXT
  FOOTNOTE
  ENDNOTE
  BIBLIOGRAPHY
}

// ============================================================================
// Admin & Institution Management
// ============================================================================

model AdminSettings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String   // JSON value
  category  String   @default("general")
  updatedAt DateTime @updatedAt
  
  @@index([category])
}

model License {
  id            String   @id @default(cuid())
  institutionId String   @unique
  institution   String
  seats         Int
  usedSeats     Int      @default(0)
  status        LicenseStatus @default(ACTIVE)
  expiresAt     DateTime
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([institutionId])
  @@index([status])
  @@index([expiresAt])
}

enum LicenseStatus {
  ACTIVE
  EXPIRED
  SUSPENDED
}

// ============================================================================
// Instructor & Assignment Management
// ============================================================================

model Assignment {
  id              String   @id @default(cuid())
  title           String
  description     String?
  courseId        String?
  instructorId    String
  dueDate         DateTime
  maxPoints       Int
  rubric          String?  // JSON rubric definition
  requirements    String?  // JSON requirements
  published       Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  submissions     Submission[]
  
  @@index([instructorId])
  @@index([courseId])
  @@index([dueDate])
  @@index([published])
}

model Submission {
  id              String   @id @default(cuid())
  assignmentId    String
  studentId       String
  content         String
  submittedAt     DateTime @default(now())
  status          SubmissionStatus @default(SUBMITTED)
  plagiarismCheck String?  // JSON plagiarism check results
  
  // Relations
  assignment      Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  grade           Grade?
  
  @@index([assignmentId])
  @@index([studentId])
  @@index([status])
  @@index([submittedAt])
}

enum SubmissionStatus {
  DRAFT
  SUBMITTED
  GRADED
  RETURNED
}

model Grade {
  id              String   @id @default(cuid())
  submissionId    String   @unique
  instructorId    String
  score           Int
  maxPoints       Int
  feedback        String?  // JSON feedback
  rubricScores    String?  // JSON rubric scores
  gradedAt        DateTime @default(now())
  
  // Relations
  submission      Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  
  @@index([instructorId])
  @@index([gradedAt])
}

// ============================================================================
// Audit & Monitoring
// ============================================================================

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String
  resource  String?  // e.g., "user", "document", "license"
  resourceId String?
  details   String?  // JSON details
  severity  AuditSeverity @default(INFO)
  ipAddress String?
  userAgent String?
  timestamp DateTime @default(now())
  
  // Relations
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([severity])
  @@index([timestamp])
}

enum AuditSeverity {
  INFO
  WARNING
  CRITICAL
}

// ============================================================================
// Analytics & Usage
// ============================================================================

model UsageMetric {
  id        String   @id @default(cuid())
  userId    String?
  metric    String   // e.g., "document_created", "citation_added"
  value     Float    @default(1)
  metadata  String?  // JSON metadata
  timestamp DateTime @default(now())
  
  @@index([userId])
  @@index([metric])
  @@index([timestamp])
}
